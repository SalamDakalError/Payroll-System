<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <title>Employee Dashboard</title>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="logo">EMP</div><h1>My Dashboard</h1></div>
      <div class="nav"><a class="btn" href="my-payroll.html">My Payroll</a><a class="btn" href="payslip.html">Payslip</a><a class="btn secondary" href="../../auth/logout.php">Logout</a></div>
    </div>

    <div class="grid" style="margin-bottom:16px">
      <div class="col-4 card kpi"><div class="label">Name</div><div class="value" id="employee-name">Loading...</div></div>
      <div class="col-4 card kpi"><div class="label">Job Title</div><div class="value" id="job-title">Loading...</div></div>
      <div class="col-4 card kpi"><div class="label">Hourly Rate</div><div class="value" id="hourly-rate">Loading...</div></div>
    </div>

    <div class="card">
      <h3>Recent Payslips</h3>
      <table><thead><tr><th>Period</th><th>Gross Pay</th><th>Net Pay</th><th>Issued</th></tr></thead>
      <tbody id="payslips-table"><tr><td colspan="4">Loading...</td></tr></tbody></table>
    </div>
  </div>
  <script src="../assets/js/main.js"></script>
  <script>
    // Load employee data
    fetch('/Payroll-System/module7-files/api-payroll/auth/check-session.php')
      .then(response => response.json())
      .then(data => {
        if (data.logged_in) {
          document.getElementById('employee-name').textContent = data.user.name;

          // Load employee details (job title and hourly rate)
          return fetch('/Payroll-System/module7-files/api-payroll/employees/read-current.php');
        } else {
          window.location.href = '/Payroll-System/module7-files/api-payroll/auth/login.php';
        }
      })
      .then(response => response.json())
      .then(employeeData => {
        if (employeeData.success) {
          document.getElementById('job-title').textContent = employeeData.employee.job_title || 'Not assigned';
          document.getElementById('hourly-rate').textContent = employeeData.employee.pay_rate ? '$' + parseFloat(employeeData.employee.pay_rate).toFixed(2) + '/hr' : 'Not set';
        } else {
          document.getElementById('job-title').textContent = 'Error loading';
          document.getElementById('hourly-rate').textContent = 'Error loading';
        }
      })
      .catch(error => {
        console.error('Error loading employee data:', error);
        document.getElementById('job-title').textContent = 'Error loading';
        document.getElementById('hourly-rate').textContent = 'Error loading';
      });

    // Load recent payslips for current employee
    fetch('/Payroll-System/module7-files/api-payroll/payslips/read-current.php')
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById('payslips-table');
        if (data.success && data.records.length > 0) {
          tbody.innerHTML = data.records.slice(0,5).map(p =>
            `<tr>
              <td>${p.pay_period}</td>
              <td>$${parseFloat(p.gross_pay || 0).toFixed(2)}</td>
              <td>$${parseFloat(p.net_pay || 0).toFixed(2)}</td>
              <td>${p.issued_date}</td>
            </tr>`
          ).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4">No payslips found</td></tr>';
        }
      })
      .catch(error => {
        console.error('Error loading payslips:', error);
        document.getElementById('payslips-table').innerHTML = '<tr><td colspan="4">Error loading payslips</td></tr>';
      });
  </script>
</body>
</html>
