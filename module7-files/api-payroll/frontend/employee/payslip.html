<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <style>
    @media print {
      .topbar, .nav {
        display: none !important;
      }
      .card {
        border: none !important;
        box-shadow: none !important;
      }
    }
    .payslip-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .earnings-section {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 6px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #888;
      width: 90%;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }

    .modal-header {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e6eef7;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h4 {
      margin: 0;
      color: #333;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close:hover,
    .close:focus {
      color: #000;
    }

    .modal-body {
      padding: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
  <title>Payslip</title>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="logo">EMP</div><h1>Payslip</h1></div>
      <div class="nav"><a class="btn secondary" href="dashboard.html">Dashboard</a><a class="btn secondary" href="../../auth/logout.php">Logout</a></div>
    </div>

    <div class="card">
      <h3>My Payslips</h3>
      <div id="payslips-list">
        <div style="text-align: center; padding: 20px;">Loading payslips...</div>
      </div>
    </div>

    <!-- Payslip Modal -->
    <div id="payslip-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h4>Payslip Details</h4>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="payslip-grid">
            <div>
              <p><strong>Pay Period:</strong> <span id="pp"></span></p>
              <p><strong>Total Hours Worked:</strong> <span id="hours"></span></p>
              <p><strong>Issued Date:</strong> <span id="issued"></span></p>
            </div>
            <div class="earnings-section">
              <h5>Earnings & Deductions</h5>
              <div style="margin-bottom: 10px;">
                <strong>Gross Pay:</strong> <span id="gross"></span>
              </div>
              <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                <div><strong>Deductions:</strong></div>
                <div style="margin-left: 10px;">
                  <div>SSS: <span id="sss-deduction"></span></div>
                  <div>PhilHealth: <span id="philhealth-deduction"></span></div>
                  <div>Pag-IBIG: <span id="pagibig-deduction"></span></div>
                  <div>Income Tax: <span id="income-tax-deduction"></span></div>
                </div>
                <div style="margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px;">
                  <strong>Total Deductions:</strong> <span id="deductions"></span>
                </div>
              </div>
              <hr style="border: none; border-top: 1px solid #e6eef7; margin: 10px 0;">
              <p style="font-size: 18px; font-weight: bold; color: #2c5aa0;"><strong>Net Pay:</strong> <span id="net"></span></p>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: center;">
            <button onclick="printPayslip()" class="btn" style="background: #28a745; border: none; margin-right: 10px;">Print Payslip</button>
            <button onclick="closeModal()" class="btn secondary">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script src="../assets/js/main.js"></script>
  <script>
    let payrollRecords = [];
    let payslipRecords = [];

    // Load payslips for current employee
    fetch('/Payroll-System/module7-files/api-payroll/auth/check-session.php')
      .then(response => response.json())
      .then(data => {
        if (data.logged_in && data.user.role_id == 3) {
          // Load payroll records for current user
          return fetch('/Payroll-System/module7-files/api-payroll/payroll/read-current.php');
        } else {
          throw new Error('Not logged in as employee');
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.records.length > 0) {
          payrollRecords = data.records;
          return fetch('/Payroll-System/module7-files/api-payroll/payslips/read-current.php');
        } else {
          displayEmptyState('No payroll records found');
          throw new Error('No payroll records');
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          payslipRecords = data.records;
          displayPayslipsList(payrollRecords, payslipRecords);
        } else {
          displayEmptyState('No payslip records found');
        }
      })
      .catch(error => {
        console.error('Error loading payslips:', error);
        if (!error.message.includes('No payroll records')) {
          displayEmptyState('Error loading payslips');
        }
      });

    function displayPayslipsList(payrolls, payslips) {
      const container = document.getElementById('payslips-list');

      if (payrolls.length === 0) {
        displayEmptyState('No payslips available');
        return;
      }

      let html = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #e6eef7;">
              <th style="padding: 12px; text-align: left; font-weight: 600;">Pay Period</th>
              <th style="padding: 12px; text-align: left; font-weight: 600;">Gross Pay</th>
              <th style="padding: 12px; text-align: left; font-weight: 600;">Net Pay</th>
              <th style="padding: 12px; text-align: left; font-weight: 600;">Issued Date</th>
              <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      payrolls.forEach(payroll => {
        const payslip = payslips.find(p => p.payroll_id == payroll.payroll_id);
        const issuedDate = payslip ? payslip.issued_date : 'Not issued';

        html += `
          <tr style="border-bottom: 1px solid #e6eef7;">
            <td style="padding: 12px;">${payroll.pay_period}</td>
            <td style="padding: 12px;">$${parseFloat(payroll.gross_pay || 0).toFixed(2)}</td>
            <td style="padding: 12px;">$${parseFloat(payroll.net_pay || 0).toFixed(2)}</td>
            <td style="padding: 12px;">${issuedDate}</td>
            <td style="padding: 12px; text-align: center;">
              <button class="btn" style="margin-right: 5px;" onclick="viewPayslip(${payroll.payroll_id})">View</button>
              <button class="btn secondary" onclick="downloadPayslip(${payroll.payroll_id})">Download</button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function displayEmptyState(message) {
      const container = document.getElementById('payslips-list');
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div>
          <div>${message}</div>
        </div>
      `;
    }

    function viewPayslip(payrollId) {
      const payroll = payrollRecords.find(p => p.payroll_id == payrollId);
      const payslip = payslipRecords.find(p => p.payroll_id == payrollId);

      if (!payroll) {
        alert('Payroll record not found');
        return;
      }

      if (!payslip) {
        alert('Payslip not issued yet');
        return;
      }

      displayPayslipDetails(payroll, payslip, payroll);
    }

    function downloadPayslip(payrollId) {
      const payroll = payrollRecords.find(p => p.payroll_id == payrollId);
      const payslip = payslipRecords.find(p => p.payroll_id == payrollId);

      if (!payroll) {
        alert('Payroll record not found');
        return;
      }

      if (!payslip) {
        alert('Payslip not issued yet');
        return;
      }

      // Create a printable version and trigger download
      const printContent = generatePayslipHTML(payroll, payslip);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    function generatePayslipHTML(payroll, payslip) {
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payslip - ${payroll.pay_period}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
            .details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .earnings { background: #f0f8ff; padding: 15px; border-radius: 6px; }
            .deductions { margin-left: 10px; font-size: 14px; color: #666; }
            .net-pay { font-size: 18px; font-weight: bold; color: #2c5aa0; margin-top: 10px; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>Payslip</h2>
            <p>Pay Period: ${payroll.pay_period}</p>
          </div>
          <div class="details">
            <div>
              <p><strong>Total Hours Worked:</strong> ${parseFloat(payroll.total_hours || 0).toFixed(2)}</p>
              <p><strong>Issued Date:</strong> ${payslip.issued_date}</p>
            </div>
            <div class="earnings">
              <h4>Earnings & Deductions</h4>
              <p><strong>Gross Pay:</strong> $${parseFloat(payroll.gross_pay || 0).toFixed(2)}</p>
              <div class="deductions">
                <div><strong>Deductions:</strong></div>
                <div style="margin-left: 10px;">
                  <div>SSS: $${parseFloat(payroll.sss_amount || 0).toFixed(2)}</div>
                  <div>PhilHealth: $${parseFloat(payroll.philhealth_amount || 0).toFixed(2)}</div>
                  <div>Pag-IBIG: $${parseFloat(payroll.pagibig_amount || 0).toFixed(2)}</div>
                  <div>Income Tax: $${parseFloat(payroll.income_tax_amount || 0).toFixed(2)}</div>
                </div>
                <div style="margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px;">
                  <strong>Total Deductions:</strong> $${parseFloat(payroll.deductions || 0).toFixed(2)}
                </div>
              </div>
              <div class="net-pay">
                <strong>Net Pay:</strong> $${parseFloat(payroll.net_pay || 0).toFixed(2)}
              </div>
            </div>
          </div>
        </body>
        </html>
      `;
    }

    function displayPayslipDetails(payroll, payslip, detailedPayroll) {
      document.getElementById('pp').textContent = payroll.pay_period;
      document.getElementById('hours').textContent = parseFloat(payroll.total_hours || 0).toFixed(2);
      document.getElementById('gross').textContent = '$' + parseFloat(payroll.gross_pay || 0).toFixed(2);

      // Individual deductions
      document.getElementById('sss-deduction').textContent = '$' + parseFloat(detailedPayroll.sss_amount || 0).toFixed(2);
      document.getElementById('philhealth-deduction').textContent = '$' + parseFloat(detailedPayroll.philhealth_amount || 0).toFixed(2);
      document.getElementById('pagibig-deduction').textContent = '$' + parseFloat(detailedPayroll.pagibig_amount || 0).toFixed(2);
      document.getElementById('income-tax-deduction').textContent = '$' + parseFloat(detailedPayroll.income_tax_amount || 0).toFixed(2);

      // Total deductions
      document.getElementById('deductions').textContent = '$' + parseFloat(detailedPayroll.deductions || 0).toFixed(2);
      document.getElementById('net').textContent = '$' + parseFloat(payroll.net_pay || 0).toFixed(2);
      document.getElementById('issued').textContent = payslip.issued_date;

      // Show modal
      document.getElementById('payslip-modal').style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeModal() {
      document.getElementById('payslip-modal').style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore scrolling
    }

    function printPayslip() {
      // Get current payslip data from modal
      const payPeriod = document.getElementById('pp').textContent;
      const hours = document.getElementById('hours').textContent;
      const gross = document.getElementById('gross').textContent.replace('$', '');
      const sss = document.getElementById('sss-deduction').textContent.replace('$', '');
      const philhealth = document.getElementById('philhealth-deduction').textContent.replace('$', '');
      const pagibig = document.getElementById('pagibig-deduction').textContent.replace('$', '');
      const incomeTax = document.getElementById('income-tax-deduction').textContent.replace('$', '');
      const totalDeductions = document.getElementById('deductions').textContent.replace('$', '');
      const net = document.getElementById('net').textContent.replace('$', '');
      const issued = document.getElementById('issued').textContent;

      // Create mock payroll and payslip objects for the print function
      const payroll = {
        pay_period: payPeriod,
        total_hours: hours,
        gross_pay: gross,
        net_pay: net,
        sss_amount: sss,
        philhealth_amount: philhealth,
        pagibig_amount: pagibig,
        income_tax_amount: incomeTax,
        deductions: totalDeductions
      };

      const payslip = {
        issued_date: issued
      };

      // Generate print content and open in new window
      const printContent = generatePayslipHTML(payroll, payslip);
      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(printContent);
      printWindow.document.close();

      // Wait for content to load then print
      printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
      };
    }

    // Add event listeners for modal close buttons
    document.addEventListener('DOMContentLoaded', function() {
      const closeBtn = document.querySelector('.close');
      const closeModalBtn = document.querySelector('.modal-body .btn.secondary');

      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
      }
    });

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('payslip-modal');
      if (event.target == modal) {
        closeModal();
      }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeModal();
      }
    });
  </script>
</body>
</html>