<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <title>Edit User</title>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="logo">EU</div><h1>Edit User</h1></div>
      <div class="nav"><a class="btn" href="users.html">Back to Users</a><a class="btn secondary" href="change-password.html">Change Password</a><a class="btn secondary" href="../shared/logout.php">Logout</a></div>
    </div>

    <div class="card">
      <h3>Edit User</h3>
      <form id="editUserForm" style="display:flex;flex-direction:column;gap:10px;max-width:400px">
        <input class="form-control" name="user_id" type="hidden" />
        <input class="form-control" name="email" placeholder="Email" required />
        <select class="form-control" name="role_id" required>
          <option value="">Select Role</option>
        </select>
        <input class="form-control" name="password" type="password" placeholder="New Password (leave empty to keep current)" />
        <div style="display:flex;gap:10px;">
          <button class="btn" type="submit">Update User</button>
          <button class="btn danger" type="button" id="deleteBtn">Delete User</button>
        </div>
      </form>
      <div id="message" style="margin-top:10px;"></div>
    </div>
  </div>
  <script src="../assets/js/main.js"></script>
  <script>
    // Check if user is logged in
    fetch('../auth/check-session.php')
      .then(res => res.json())
      .then(data => {
        if (!data.logged_in || data.role_id != 1) {
          document.getElementById('message').innerHTML = '<div class="alert alert-danger">You must be logged in as admin to access this page.</div>';
          document.getElementById('editUserForm').style.display = 'none';
          return;
        }
        // Continue with normal loading
        loadPage();
      })
      .catch(err => {
        console.error('Session check failed:', err);
        document.getElementById('message').innerHTML = '<div class="alert alert-danger">Session check failed.</div>';
      });

    function loadPage() {
      // Get user ID from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id');

      if (!userId) {
        document.getElementById('message').innerHTML = '<div class="alert alert-danger">No user ID provided.</div>';
      } else {
        document.querySelector('input[name="user_id"]').value = userId;
        loadUserData(userId);
        loadRoles();
      }
    }

    function loadRoles() {
      apiFetch('../roles/read-all.php').then(json => {
        const select = document.querySelector('select[name="role_id"]');
        if (json && json.records) {
          select.innerHTML = '<option value="">Select Role</option>' +
            json.records.map(r => `<option value="${r.role_id}">${r.role_name}</option>`).join('');
        }
      });
    }

    function loadUserData(userId) {
      apiFetch(`../users/read-one.php?id=${userId}`).then(json => {
        if (json && json.user) {
          const user = json.user;
          document.querySelector('input[name="email"]').value = user.email;
          document.querySelector('select[name="role_id"]').value = user.role_id;
        } else {
          document.getElementById('message').innerHTML = '<div class="alert alert-danger">User not found.</div>';
        }
      });
    }

    document.getElementById('editUserForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {
        user_id: fd.get('user_id'),
        email: fd.get('email'),
        role_id: fd.get('role_id'),
        password: fd.get('password')
      };

      const res = await apiFetch('../users/update.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res && res.success) {
        document.getElementById('message').innerHTML = '<div class="alert alert-success">User updated successfully.</div>';
      } else {
        document.getElementById('message').innerHTML = '<div class="alert alert-danger">' + (res.message || 'Failed to update user.') + '</div>';
      }
    });

    document.getElementById('deleteBtn').addEventListener('click', async () => {
      console.log('Delete button clicked');
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        console.log('Delete cancelled by user');
        return;
      }

      try {
        const response = await fetch(`../users/delete.php?id=${userId}`);
        const result = await response.json();
        console.log('Delete response:', result);

        if (result.success) {
          alert('User deleted successfully');
          window.location.href = 'users.html';
        } else {
          alert('Error: ' + (result.message || 'Failed to delete user'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('An error occurred while deleting the user');
      }
    });
  </script>
</body>
</html>